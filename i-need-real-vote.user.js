// ==UserScript==
// @name         I need real vote
// @namespace    i-need-real-vote@sevenc7c
// @version      0.1.0
// @description
// @author       Nanashi.
// @match        https://twitter.com/*
// @match        https://www.twitter.com/*
// @match        https://x.com/*
// @match        https://youtube.com/*
// @match        https://www.youtube.com/*
// @icon         https://raw.githubusercontent.com/sevenc-nanashi/i-need-real-vote/main/static/128.png
// @updateURL    https://raw.githubusercontent.com/sevenc-nanashi/i-need-real-vote/release/i-need-real-vote.user.js
// ==/UserScript==
(()=>{var U=Object.create;var A=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var X=(e,r,i)=>r in e?A(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i;var _=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var Q=(e,r,i,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of $(r))!B.call(e,a)&&a!==i&&A(e,a,{get:()=>r[a],enumerable:!(o=V(r,a))||o.enumerable});return e};var K=(e,r,i)=>(i=e!=null?U(j(e)):{},Q(r||!e||!e.__esModule?A(i,"default",{value:e,enumerable:!0}):i,e));var h=(e,r,i)=>(X(e,typeof r!="symbol"?r+"":r,i),i);var O=_((Z,C)=>{"use strict";var p=function(e){if(e=e||{},this.Promise=e.Promise||Promise,this.queues=Object.create(null),this.domainReentrant=e.domainReentrant||!1,this.domainReentrant){if(typeof process>"u"||typeof process.domain>"u")throw new Error("Domain-reentrant locks require `process.domain` to exist. Please flip `opts.domainReentrant = false`, use a NodeJS version that still implements Domain, or install a browser polyfill.");this.domains=Object.create(null)}this.timeout=e.timeout||p.DEFAULT_TIMEOUT,this.maxOccupationTime=e.maxOccupationTime||p.DEFAULT_MAX_OCCUPATION_TIME,this.maxExecutionTime=e.maxExecutionTime||p.DEFAULT_MAX_EXECUTION_TIME,e.maxPending===1/0||Number.isInteger(e.maxPending)&&e.maxPending>=0?this.maxPending=e.maxPending:this.maxPending=p.DEFAULT_MAX_PENDING};p.DEFAULT_TIMEOUT=0;p.DEFAULT_MAX_OCCUPATION_TIME=0;p.DEFAULT_MAX_EXECUTION_TIME=0;p.DEFAULT_MAX_PENDING=1e3;p.prototype.acquire=function(e,r,i,o){if(Array.isArray(e))return this._acquireBatch(e,r,i,o);if(typeof r!="function")throw new Error("You must pass a function to execute");var a=null,m=null,c=null;typeof i!="function"&&(o=i,i=null,c=new this.Promise(function(f,g){a=f,m=g})),o=o||{};var l=!1,u=null,d=null,t=null,n=this,s=function(f,g,T){d&&(clearTimeout(d),d=null),t&&(clearTimeout(t),t=null),f&&(n.queues[e]&&n.queues[e].length===0&&delete n.queues[e],n.domainReentrant&&delete n.domains[e]),l||(c?g?m(g):a(T):typeof i=="function"&&i(g,T),l=!0),f&&n.queues[e]&&n.queues[e].length>0&&n.queues[e].shift()()},v=function(f){if(l)return s(f);u&&(clearTimeout(u),u=null),n.domainReentrant&&f&&(n.domains[e]=process.domain);var g=o.maxExecutionTime||n.maxExecutionTime;if(g&&(t=setTimeout(function(){n.queues[e]&&s(f,new Error("Maximum execution time is exceeded "+e))},g)),r.length===1){var T=!1;try{r(function(q,F){T||(T=!0,s(f,q,F))})}catch(q){T||(T=!0,s(f,q))}}else n._promiseTry(function(){return r()}).then(function(q){s(f,void 0,q)},function(q){s(f,q)})};n.domainReentrant&&process.domain&&(v=process.domain.bind(v));var E=o.maxPending||n.maxPending;if(!n.queues[e])n.queues[e]=[],v(!0);else if(n.domainReentrant&&process.domain&&process.domain===n.domains[e])v(!1);else if(n.queues[e].length>=E)s(!1,new Error("Too many pending tasks in queue "+e));else{var x=function(){v(!0)};o.skipQueue?n.queues[e].unshift(x):n.queues[e].push(x);var y=o.timeout||n.timeout;y&&(u=setTimeout(function(){u=null,s(!1,new Error("async-lock timed out in queue "+e))},y))}var I=o.maxOccupationTime||n.maxOccupationTime;if(I&&(d=setTimeout(function(){n.queues[e]&&s(!1,new Error("Maximum occupation time is exceeded in queue "+e))},I)),c)return c};p.prototype._acquireBatch=function(e,r,i,o){typeof i!="function"&&(o=i,i=null);var a=this,m=function(l,u){return function(d){a.acquire(l,u,d,o)}},c=e.reduceRight(function(l,u){return m(u,l)},r);if(typeof i=="function")c(i);else return new this.Promise(function(l,u){c.length===1?c(function(d,t){d?u(d):l(t)}):l(c())})};p.prototype.isBusy=function(e){return e?!!this.queues[e]:Object.keys(this.queues).length>0};p.prototype._promiseTry=function(e){try{return this.Promise.resolve(e())}catch(r){return this.Promise.reject(r)}};C.exports=p});var N=_((k,H)=>{"use strict";H.exports=O()});function L(e){if(typeof e!="string")throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}var P={name:"i-need-real-vote",version:"0.1.0",homepage:"https://github.com/sevenc-nanashi/i-need-real-vote",description:"",main:"index.js",scripts:{test:'echo "Error: no test specified" && exit 1',build:"node --loader ts-node/esm ./build.cts --pack",dev:'nodemon --ext mts,cts --exec "node --loader ts-node/esm ./build.cts"',lint:"eslint --ext .mjs,.mts,.cts,.ts .","lint:fix":"eslint --ext .mjs,.mts,.cts,.ts . --fix"},keywords:[],author:"",license:"ISC",devDependencies:{"@types/adm-zip":"^0.5.5","@types/async-lock":"^1.4.2","@types/js-yaml":"^4.0.9","@types/node":"^20.11.13","@typescript-eslint/eslint-plugin":"^6.20.0","@typescript-eslint/parser":"^6.20.0","adm-zip":"^0.5.10",esbuild:"^0.20.0",eslint:"^8.56.0","eslint-config-prettier":"^9.1.0","eslint-plugin-prettier":"^5.1.3","js-yaml":"^4.1.0",nodemon:"^3.0.3",prettier:"^3.2.4","ts-node":"^10.9.2",typescript:"^5.3.3"},dependencies:{"async-lock":"^1.4.1","escape-string-regexp":"^5.0.0"}};var R=K(N(),1);var S=class{constructor(){h(this,"lock",new R.default);h(this,"queue",[])}init(){console.log(`%c== I need real vote ======================================
  \u6295\u7968\u7D50\u679C\u304B\u3089\u300C\u95B2\u89A7\u7528\u300D\u3092\u7121\u304F\u3057\u305F\u5272\u5408\u3092\u8868\u793A\u3059\u308B\u62E1\u5F35\u6A5F\u80FD
  %cVersion: %cv${P.version}
  %cDeveloped by %cNanashi.
  %c${P.homepage}
%c----------------------------------------------------------
Provider: ${this.name}
`,"color: #dd2e44","color: auto","color: #dd2e44","color: auto","color: #48b0d5","color: auto","color: #dd2e44"),this.run()}matchesUrl(r){for(let i of this.matches)if(r.match(new RegExp("^"+L(i).replace(/\\\*/g,".*")+"$")))return!0}processQueue(){this.lock.acquire("processQueue",async()=>{let r=this.queue;this.queue=[];for(let i of r)this.process(i)})}},b=e=>{let r=e.reduce((i,o)=>i+o,0);return r===0?{ratios:e.map(()=>0),total:r}:{ratios:e.map(i=>i/r),total:r}},w=["\u95B2\u89A7\u7528","\u7D50\u679C\u3092\u898B\u308B","\u898B\u308B\u3060\u3051","\u7D50\u679C\u3060\u3051\u898B\u308B"];var D=class extends S{constructor(){super(...arguments);h(this,"name","twitter");h(this,"matches",["https://twitter.com/*","https://www.twitter.com/*","https://x.com/*"])}run(){this.main()}main(){let i=document.querySelector("main[role=main]");if(!i){setTimeout(this.main,100);return}new MutationObserver(async()=>{await new Promise(m=>requestAnimationFrame(m));let a=i.querySelectorAll('div[data-testid="cardPoll"]:not([data-inrv-processed])');this.queue.push(...Array.from(a)),this.processQueue()}).observe(i,{childList:!0,subtree:!0})}process(i){console.log("Processing: ",i);let o=Array.from(i.querySelectorAll("ul > li > div"));if(o.length===0){console.log("Skipped: No vote elements");return}let a=o.map(t=>{let n=t.querySelector("div.r-f727ji span"),s=t.querySelector("div.r-1wbh5a2 span span");if(!n||!s)return;let v=Array.from(t.childNodes).find(y=>y instanceof HTMLDivElement&&y.style.width),E=n.textContent?.trim().replace("%",""),x=s.textContent?.trim();if(!(!E||!x))return{ratio:parseFloat(E)/100,text:x,baseElement:t,ratioBarDiv:v,ratioSpan:n,textSpan:s}});if(!a.every(t=>t)){console.log("Skipped: Invalid vote elements");return}i.setAttribute("data-inrv-processed","");let m=a.map(t=>t),c=m.filter(t=>!w.some(n=>t.text.includes(n))),l=m.filter(t=>w.some(n=>t.text.includes(n)));if(l.length===0){console.log("Skipped: No invalid votes");return}if(c.length===0){console.log("Skipped: No valid votes");return}let u=c.map(t=>t.ratio),d=b(u);for(let t of l)t.baseElement.style.opacity="0.5",t.ratioSpan.textContent=`(${(t.ratio*100).toFixed(1)}%)`,t.ratioBarDiv.style.display="none";for(let[t,n]of Object.entries(c)){let s=d.ratios[parseInt(t)];n.ratioSpan.textContent=`${(s*100).toFixed(1)}% (${(n.ratio*100).toFixed(1)}%)`,n.ratioBarDiv.style.width=`${s*100}%`}}};var M=class extends S{constructor(){super(...arguments);h(this,"name","youtube");h(this,"matches",["https://youtube.com/*","https://www.youtube.com/*"])}run(){this.main()}main(){let i=document.querySelector("ytd-app");if(!i){setTimeout(this.main,100);return}new MutationObserver(async()=>{await new Promise(m=>requestAnimationFrame(m));let a=i.querySelectorAll("ytd-backstage-poll-renderer:not([data-inrv-processed])");this.queue.push(...Array.from(a)),this.processQueue()}).observe(i,{childList:!0,subtree:!0})}process(i){console.log("Processing: ",i);let o=Array.from(i.querySelectorAll(".choice-info.style-scope.ytd-backstage-poll-renderer"));if(o.length===0){console.log("Skipped: No vote elements");return}let a=o.map(t=>{let n=t.querySelector("yt-formatted-string.vote-percentage"),s=t.querySelector("yt-formatted-string.choice-text");if(!n||!s)return;let v=[t.querySelector(".progress-bar"),t.querySelector(".vote-percentage-area")].filter(y=>y),E=n.textContent?.trim().replace("%",""),x=s.textContent?.trim();if(!(!E||!x))return{ratio:parseFloat(E)/100,text:x,baseElement:t,ratioBarDivs:v,ratioSpan:n,textSpan:s}});if(!a.every(t=>t)){console.log("Skipped: Invalid vote elements");return}i.setAttribute("data-inrv-processed","");let m=a.map(t=>t),c=m.filter(t=>!w.some(n=>t.text.includes(n))),l=m.filter(t=>w.some(n=>t.text.includes(n)));if(l.length===0){console.log("Skipped: No invalid votes");return}if(c.length===0){console.log("Skipped: No valid votes");return}let u=c.map(t=>t.ratio),d=b(u);for(let t of l){t.baseElement.style.opacity="0.5",t.ratioSpan.textContent=`(${(t.ratio*100).toFixed()}%)`;for(let n of t.ratioBarDivs)n.style.display="none"}for(let[t,n]of Object.entries(c)){let s=d.ratios[parseInt(t)];n.ratioSpan.textContent=`${(s*100).toFixed()}% (${(n.ratio*100).toFixed()}%)`;for(let v of n.ratioBarDivs)v.style.width=`${s*100}%`}}};var G=[new D,new M];(()=>{for(let e of G)if(e.matchesUrl(location.href)){e.init();return}console.error("No provider matched")})();})();
